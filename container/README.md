### Proof-of-concept implementation of the "PISM on AWS" container

This container (pushed to `ckhrulev/pism-for-aws:latest`, see https://hub.docker.com/repository/docker/ckhrulev/pism-for-aws/general)
- uses `boto3` or `pycurl` to stage inputs,
- runs a command, capturing `stdout` and `stderr`
- creates a list of files generated by this command
- uses `boto3` to upload these files to an S3 bucket

All errors are considered fatal, so error recovery is not attempted.

Assumes that AWS credentials are set using `~/.aws/credentials` or environment variables.

Uses a non-privileged user `worker` (OpenMPI strongly suggests that one should avoid running as `root`).

#### Running PISM

Here's one way to run it:
``` bash

TAG=ckhrulev/pism-for-aws

parameters='{"inputs" : [], "command" : "mpiexec -n 1 pismr -eisII A -y 10 -Mx 5 -My 5 -Mz 3 -o eis2-A.nc", "output" : "s3://pism-cloud-play/eis2-A"}'

docker run --cap-add=sys_nice --rm -v ${HOME}/.aws:/home/worker/.aws ${TAG} "${parameters}"
```

The entry point of the container uses one argument: a JSON document listing files to stage, the command to run, and the S3 bucket and prefix to use to upload results.

This should produce something similar to
```
INFO:root:Running 'mpiexec -n 1 pismr -eisII A -y 10 -Mx 5 -My 5 -Mz 3 -o eis2-A.nc' in '/tmp/tmpxwbaulg2'
INFO:root:Command generated ['/tmp/tmpxwbaulg2/eis2-A.nc', '/tmp/tmpxwbaulg2/stdout.log']
INFO:root:Uploading file='/tmp/tmpxwbaulg2/eis2-A.nc' to bucket_name=pism-cloud-play, object_name=eis2-A/eis2-A.nc
INFO:botocore.credentials:Found credentials in shared credentials file: ~/.aws/credentials
INFO:root:Uploading file='/tmp/tmpxwbaulg2/stdout.log' to bucket_name=pism-cloud-play, object_name=eis2-A/stdout.log
INFO:root:Removing '/tmp/tmpxwbaulg2' and its contents
```

Note that this PISM run has no inputs. In general `parameters` would contain something like
```
{"inputs": ["https://foo.com/input.nc",
            "ftp://bar.org/climate.nc",
            ["s3://bucket-name/object-name", "forcing.nc"]],
 "command": "mpiexec -n 8 pismr -i input.nc -o output.nc ...",
 "output": "s3://bucket-name/prefix/"}
```

Here `inputs` is a list specifying input files to stage. Each element is either an URL string (in this case the URL is used to determine the file name to use) or a two-element list (in this case the first element is the URL and the second one is the file name).

The `command` should save outputs into the current working directory. Flags in `command` should not contain absolute paths or paths containing sub-directories.

Run
```
docker run --rm ckhrulev/pism-for-aws --help
```
for details.

#### Process binding

The `docker run` command above contains the flag `--cap-add=sys_nice`. This option may be needed for MPI process binding (which may improve performance).

<!-- Local Variables: -->
<!-- fill-column: 1000 -->
<!-- eval: (visual-line-mode t) -->
<!-- End: -->
